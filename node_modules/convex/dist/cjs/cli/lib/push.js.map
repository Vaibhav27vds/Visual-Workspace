{
  "version": 3,
  "sources": ["../../../../src/cli/lib/push.ts"],
  "sourcesContent": ["import chalk from \"chalk\";\nimport { Context, logMessage } from \"../../bundler/context.js\";\nimport { doCodegen } from \"./codegen.js\";\nimport {\n  configFromProjectConfig,\n  configJSON,\n  diffConfig,\n  pullConfig,\n  pushConfig,\n  readProjectConfig,\n} from \"./config.js\";\nimport { pushSchema } from \"./indexes.js\";\nimport { typeCheckFunctionsInMode } from \"./typecheck.js\";\nimport { ensureHasConvexDependency, functionsDir } from \"./utils.js\";\n\nexport type PushOptions = {\n  adminKey: string;\n  verbose: boolean;\n  dryRun: boolean;\n  typecheck: \"enable\" | \"try\" | \"disable\";\n  debug: boolean;\n  debugBundlePath?: string;\n  codegen: boolean;\n  url: string;\n};\n\nexport async function runPush(ctx: Context, options: PushOptions) {\n  const timeRunPushStarts = performance.now();\n  const { configPath, projectConfig } = await readProjectConfig(ctx);\n  const origin = options.url;\n  const verbose = options.verbose || options.dryRun;\n  await ensureHasConvexDependency(ctx, \"push\");\n\n  if (!options.codegen) {\n    logMessage(\n      ctx,\n      chalk.gray(\"Skipping codegen. Remove --codegen=disable to enable.\")\n    );\n    // Codegen includes typechecking, so if we're skipping it, run the type\n    // check manually on the query and mutation functions\n    const funcDir = functionsDir(configPath, projectConfig);\n    await typeCheckFunctionsInMode(ctx, options.typecheck, funcDir);\n  } else {\n    await doCodegen({\n      ctx,\n      functionsDirectoryPath: functionsDir(configPath, projectConfig),\n      typeCheckMode: options.typecheck,\n      dryRun: options.dryRun,\n      debug: options.debug,\n      quiet: true,\n    });\n    if (verbose) {\n      logMessage(ctx, chalk.green(\"Codegen finished.\"));\n    }\n  }\n\n  const timeBundleStarts = performance.now();\n  const { config: localConfig, bundledModuleInfos } =\n    await configFromProjectConfig(ctx, projectConfig, configPath, verbose);\n\n  if (options.debugBundlePath) {\n    const config = configJSON(localConfig, options.adminKey);\n    ctx.fs.writeUtf8File(options.debugBundlePath, JSON.stringify(config));\n    return;\n  }\n\n  const timeSchemaPushStarts = performance.now();\n  const { schemaId, schemaState } = await pushSchema(\n    ctx,\n    origin,\n    options.adminKey,\n    functionsDir(configPath, localConfig.projectConfig),\n    options.dryRun\n  );\n\n  const timeConfigPullStarts = performance.now();\n  const remoteConfig = await pullConfig(\n    ctx,\n    undefined,\n    undefined,\n    origin,\n    options.adminKey\n  );\n\n  const diff = diffConfig(remoteConfig, localConfig);\n  if (diff === \"\" && schemaState?.state === \"active\") {\n    if (verbose) {\n      const msg =\n        localConfig.modules.length === 0\n          ? `No functions found in ${localConfig.projectConfig.functions}`\n          : \"Config already synced\";\n      logMessage(\n        ctx,\n        chalk.gray(\n          `${\n            options.dryRun\n              ? \"Command would skip function push\"\n              : \"Function push skipped\"\n          }: ${msg}.`\n        )\n      );\n    }\n    return;\n  }\n\n  if (verbose) {\n    logMessage(\n      ctx,\n      chalk.bold(\n        `Remote config ${\n          options.dryRun ? \"would\" : \"will\"\n        } be overwritten with the following changes:`\n      )\n    );\n    logMessage(ctx, diff);\n  }\n\n  if (options.dryRun) {\n    return;\n  }\n\n  // Note that this is not quite a user pain metric: we're missing any time\n  // spent making and retrying this network request and receiving the response.\n  const timePushStarts = performance.now();\n  const timing = {\n    typecheck: (timeBundleStarts - timeRunPushStarts) / 1000,\n    bundle: (timeSchemaPushStarts - timeBundleStarts) / 1000,\n    schemaPush: (timeConfigPullStarts - timeSchemaPushStarts) / 1000,\n    codePull: (timePushStarts - timeConfigPullStarts) / 1000,\n    totalBeforePush: (timePushStarts - timeRunPushStarts) / 1000,\n  };\n  await pushConfig(\n    ctx,\n    localConfig,\n    options.adminKey,\n    options.url,\n    timing,\n    schemaId,\n    bundledModuleInfos\n  );\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAkB;AAClB,qBAAoC;AACpC,qBAA0B;AAC1B,oBAOO;AACP,qBAA2B;AAC3B,uBAAyC;AACzC,mBAAwD;AAaxD,eAAsB,QAAQ,KAAc,SAAsB;AAChE,QAAM,oBAAoB,YAAY,IAAI;AAC1C,QAAM,EAAE,YAAY,cAAc,IAAI,UAAM,iCAAkB,GAAG;AACjE,QAAM,SAAS,QAAQ;AACvB,QAAM,UAAU,QAAQ,WAAW,QAAQ;AAC3C,YAAM,wCAA0B,KAAK,MAAM;AAE3C,MAAI,CAAC,QAAQ,SAAS;AACpB;AAAA,MACE;AAAA,MACA,aAAAA,QAAM,KAAK,uDAAuD;AAAA,IACpE;AAGA,UAAM,cAAU,2BAAa,YAAY,aAAa;AACtD,cAAM,2CAAyB,KAAK,QAAQ,WAAW,OAAO;AAAA,EAChE,OAAO;AACL,cAAM,0BAAU;AAAA,MACd;AAAA,MACA,4BAAwB,2BAAa,YAAY,aAAa;AAAA,MAC9D,eAAe,QAAQ;AAAA,MACvB,QAAQ,QAAQ;AAAA,MAChB,OAAO,QAAQ;AAAA,MACf,OAAO;AAAA,IACT,CAAC;AACD,QAAI,SAAS;AACX,qCAAW,KAAK,aAAAA,QAAM,MAAM,mBAAmB,CAAC;AAAA,IAClD;AAAA,EACF;AAEA,QAAM,mBAAmB,YAAY,IAAI;AACzC,QAAM,EAAE,QAAQ,aAAa,mBAAmB,IAC9C,UAAM,uCAAwB,KAAK,eAAe,YAAY,OAAO;AAEvE,MAAI,QAAQ,iBAAiB;AAC3B,UAAM,aAAS,0BAAW,aAAa,QAAQ,QAAQ;AACvD,QAAI,GAAG,cAAc,QAAQ,iBAAiB,KAAK,UAAU,MAAM,CAAC;AACpE;AAAA,EACF;AAEA,QAAM,uBAAuB,YAAY,IAAI;AAC7C,QAAM,EAAE,UAAU,YAAY,IAAI,UAAM;AAAA,IACtC;AAAA,IACA;AAAA,IACA,QAAQ;AAAA,QACR,2BAAa,YAAY,YAAY,aAAa;AAAA,IAClD,QAAQ;AAAA,EACV;AAEA,QAAM,uBAAuB,YAAY,IAAI;AAC7C,QAAM,eAAe,UAAM;AAAA,IACzB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA,QAAQ;AAAA,EACV;AAEA,QAAM,WAAO,0BAAW,cAAc,WAAW;AACjD,MAAI,SAAS,MAAM,aAAa,UAAU,UAAU;AAClD,QAAI,SAAS;AACX,YAAM,MACJ,YAAY,QAAQ,WAAW,IAC3B,yBAAyB,YAAY,cAAc,cACnD;AACN;AAAA,QACE;AAAA,QACA,aAAAA,QAAM;AAAA,UACJ,GACE,QAAQ,SACJ,qCACA,4BACD;AAAA,QACP;AAAA,MACF;AAAA,IACF;AACA;AAAA,EACF;AAEA,MAAI,SAAS;AACX;AAAA,MACE;AAAA,MACA,aAAAA,QAAM;AAAA,QACJ,iBACE,QAAQ,SAAS,UAAU;AAAA,MAE/B;AAAA,IACF;AACA,mCAAW,KAAK,IAAI;AAAA,EACtB;AAEA,MAAI,QAAQ,QAAQ;AAClB;AAAA,EACF;AAIA,QAAM,iBAAiB,YAAY,IAAI;AACvC,QAAM,SAAS;AAAA,IACb,YAAY,mBAAmB,qBAAqB;AAAA,IACpD,SAAS,uBAAuB,oBAAoB;AAAA,IACpD,aAAa,uBAAuB,wBAAwB;AAAA,IAC5D,WAAW,iBAAiB,wBAAwB;AAAA,IACpD,kBAAkB,iBAAiB,qBAAqB;AAAA,EAC1D;AACA,YAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA,QAAQ;AAAA,IACR,QAAQ;AAAA,IACR;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;",
  "names": ["chalk"]
}
