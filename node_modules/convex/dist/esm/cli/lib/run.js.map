{
  "version": 3,
  "sources": ["../../../../src/cli/lib/run.ts"],
  "sourcesContent": ["import chalk from \"chalk\";\nimport util from \"util\";\nimport ws from \"ws\";\nimport { ConvexHttpClient } from \"../../browser/http_client-node.js\";\nimport { BaseConvexClient } from \"../../browser/index.js\";\nimport { makeFunctionReference } from \"../../server/index.js\";\nimport { Value, convexToJson } from \"../../values/value.js\";\nimport {\n  Context,\n  logError,\n  logFailure,\n  logFinishedStep,\n  logMessage,\n  logOutput,\n} from \"../../bundler/context.js\";\n\nexport async function runFunctionAndLog(\n  ctx: Context,\n  deploymentUrl: string,\n  adminKey: string,\n  functionName: string,\n  args: Value,\n  callbacks?: {\n    onSuccess?: () => void;\n  }\n) {\n  const client = new ConvexHttpClient(deploymentUrl);\n  client.setAdminAuth(adminKey);\n\n  let result: Value;\n  try {\n    result = await client.function(makeFunctionReference(functionName), args);\n  } catch (err) {\n    logFailure(ctx, `Failed to run function \"${functionName}\":`);\n    logError(ctx, chalk.red((err as Error).toString().trim()));\n    return await ctx.crash(1, \"invalid filesystem or env vars\");\n  }\n\n  callbacks?.onSuccess?.();\n\n  // `null` is the default return type\n  if (result !== null) {\n    logOutput(ctx, formatValue(result));\n  }\n}\n\nexport function formatValue(value: Value) {\n  const json = convexToJson(value);\n  if (process.stdout.isTTY) {\n    // TODO (Tom) add JSON syntax highlighting like https://stackoverflow.com/a/51319962/398212\n    // until then, just spit out something that isn't quite JSON because it's easy\n    return util.inspect(value, { colors: true, depth: null });\n  } else {\n    return JSON.stringify(json, null, 2);\n  }\n}\n\nexport async function subscribeAndLog(\n  ctx: Context,\n  deploymentUrl: string,\n  adminKey: string,\n  functionName: string,\n  args: Record<string, Value>\n) {\n  return subscribe(\n    ctx,\n    deploymentUrl,\n    adminKey,\n    functionName,\n    args,\n    \"indefinitely\",\n    {\n      onStart() {\n        logFinishedStep(\n          ctx,\n          `Watching query ${functionName} on ${deploymentUrl}...`\n        );\n      },\n      onChange(client) {\n        logOutput(\n          ctx,\n          formatValue(client.localQueryResult(functionName, args)!)\n        );\n      },\n      onStop() {\n        logMessage(ctx, `Closing connection to ${deploymentUrl}...`);\n      },\n    }\n  );\n}\n\nexport async function subscribe(\n  ctx: Context,\n  deploymentUrl: string,\n  adminKey: string,\n  functionName: string,\n  args: Record<string, Value>,\n  until: \"first change\" | \"indefinitely\",\n  callbacks?: {\n    onStart?: (client: BaseConvexClient) => void;\n    onChange?: (client: BaseConvexClient) => void;\n    onStop?: () => void;\n  }\n) {\n  let changes = 0;\n  const client = new BaseConvexClient(\n    deploymentUrl,\n    (updatedQueries) => {\n      // First bump is just the initial results reporting\n      for (const _ of updatedQueries) {\n        changes++;\n        callbacks?.onChange?.(client);\n        if (until === \"first change\" && changes > 1) {\n          stopWatching();\n        }\n      }\n    },\n    {\n      // pretend that a Node.js 'ws' library WebSocket is a browser WebSocket\n      webSocketConstructor: ws as unknown as typeof WebSocket,\n      unsavedChangesWarning: false,\n    }\n  );\n  client.setAdminAuth(adminKey);\n  const { unsubscribe } = client.subscribe(functionName, args);\n\n  callbacks?.onStart?.(client);\n\n  let done = false;\n  let onDone: (v: unknown) => void;\n  const stopWatching = () => {\n    unsubscribe();\n    void client.close();\n    process.off(\"SIGINT\", sigintListener);\n    done = true;\n    onDone(null);\n  };\n  const doneP = new Promise((resolve) => (onDone = resolve));\n  function sigintListener() {\n    stopWatching();\n  }\n  process.on(\"SIGINT\", sigintListener);\n  while (!done) {\n    // loops once per day (any large value < 2**31 would work)\n    const oneDay = 24 * 60 * 60 * 1000;\n    await Promise.race([\n      doneP,\n      new Promise((resolve) => setTimeout(resolve, oneDay)),\n    ]);\n  }\n}\n"],
  "mappings": ";AAAA,OAAO,WAAW;AAClB,OAAO,UAAU;AACjB,OAAO,QAAQ;AACf,SAAS,wBAAwB;AACjC,SAAS,wBAAwB;AACjC,SAAS,6BAA6B;AACtC,SAAgB,oBAAoB;AACpC;AAAA,EAEE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,OACK;AAEP,sBAAsB,kBACpB,KACA,eACA,UACA,cACA,MACA,WAGA;AACA,QAAM,SAAS,IAAI,iBAAiB,aAAa;AACjD,SAAO,aAAa,QAAQ;AAE5B,MAAI;AACJ,MAAI;AACF,aAAS,MAAM,OAAO,SAAS,sBAAsB,YAAY,GAAG,IAAI;AAAA,EAC1E,SAAS,KAAP;AACA,eAAW,KAAK,2BAA2B,gBAAgB;AAC3D,aAAS,KAAK,MAAM,IAAK,IAAc,SAAS,EAAE,KAAK,CAAC,CAAC;AACzD,WAAO,MAAM,IAAI,MAAM,GAAG,gCAAgC;AAAA,EAC5D;AAEA,aAAW,YAAY;AAGvB,MAAI,WAAW,MAAM;AACnB,cAAU,KAAK,YAAY,MAAM,CAAC;AAAA,EACpC;AACF;AAEO,gBAAS,YAAY,OAAc;AACxC,QAAM,OAAO,aAAa,KAAK;AAC/B,MAAI,QAAQ,OAAO,OAAO;AAGxB,WAAO,KAAK,QAAQ,OAAO,EAAE,QAAQ,MAAM,OAAO,KAAK,CAAC;AAAA,EAC1D,OAAO;AACL,WAAO,KAAK,UAAU,MAAM,MAAM,CAAC;AAAA,EACrC;AACF;AAEA,sBAAsB,gBACpB,KACA,eACA,UACA,cACA,MACA;AACA,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,MACE,UAAU;AACR;AAAA,UACE;AAAA,UACA,kBAAkB,mBAAmB;AAAA,QACvC;AAAA,MACF;AAAA,MACA,SAAS,QAAQ;AACf;AAAA,UACE;AAAA,UACA,YAAY,OAAO,iBAAiB,cAAc,IAAI,CAAE;AAAA,QAC1D;AAAA,MACF;AAAA,MACA,SAAS;AACP,mBAAW,KAAK,yBAAyB,kBAAkB;AAAA,MAC7D;AAAA,IACF;AAAA,EACF;AACF;AAEA,sBAAsB,UACpB,KACA,eACA,UACA,cACA,MACA,OACA,WAKA;AACA,MAAI,UAAU;AACd,QAAM,SAAS,IAAI;AAAA,IACjB;AAAA,IACA,CAAC,mBAAmB;AAElB,iBAAW,KAAK,gBAAgB;AAC9B;AACA,mBAAW,WAAW,MAAM;AAC5B,YAAI,UAAU,kBAAkB,UAAU,GAAG;AAC3C,uBAAa;AAAA,QACf;AAAA,MACF;AAAA,IACF;AAAA,IACA;AAAA;AAAA,MAEE,sBAAsB;AAAA,MACtB,uBAAuB;AAAA,IACzB;AAAA,EACF;AACA,SAAO,aAAa,QAAQ;AAC5B,QAAM,EAAE,YAAY,IAAI,OAAO,UAAU,cAAc,IAAI;AAE3D,aAAW,UAAU,MAAM;AAE3B,MAAI,OAAO;AACX,MAAI;AACJ,QAAM,eAAe,MAAM;AACzB,gBAAY;AACZ,SAAK,OAAO,MAAM;AAClB,YAAQ,IAAI,UAAU,cAAc;AACpC,WAAO;AACP,WAAO,IAAI;AAAA,EACb;AACA,QAAM,QAAQ,IAAI,QAAQ,CAAC,YAAa,SAAS,OAAQ;AACzD,WAAS,iBAAiB;AACxB,iBAAa;AAAA,EACf;AACA,UAAQ,GAAG,UAAU,cAAc;AACnC,SAAO,CAAC,MAAM;AAEZ,UAAM,SAAS,KAAK,KAAK,KAAK;AAC9B,UAAM,QAAQ,KAAK;AAAA,MACjB;AAAA,MACA,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,MAAM,CAAC;AAAA,IACtD,CAAC;AAAA,EACH;AACF;",
  "names": []
}
